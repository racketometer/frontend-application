import { Injectable } from "@angular/core";
import { Router } from "@angular/router";
import { Angular2Apollo } from "angular2-apollo";
import { ApolloQueryResult } from "apollo-client";
import gql from "graphql-tag";

import {
  IViewer,
  Login,
  PersistenceService,
  User,
} from "../";

@Injectable()
export class LoginService {
  public email: string;
  public oldPassword: string;
  private tokenKey: string = "loginToken";
  private token: string;

  get isLoggedIn(): boolean {
    return !!this.token;
  }

  constructor(
    private apollo: Angular2Apollo,
    private persistence: PersistenceService,
    private router: Router,
  ) {
    persistence.read<string>(this.tokenKey)
      .then(token => this.token = token);
  }

  /**
   * Perform a user login.
   * @param user The user credentials.
   */
  public login(user: Login): Promise<User> {
    return this.apollo
      .query({
        query: gql`
          query login($email: String!, $password: String!) {
            login(email: $email, password: $password) {
              user {
                autoGenerated
              }
              token
            }
          }
        `,
        variables: {
          email: user.email,
          password: user.password,
        },
      })
      .then((result: ApolloQueryResult) => {
        const viewer = result.data.login as IViewer;
        if (!viewer) {
          return Promise.reject<IViewer>("User not found");
        }
        this.token = viewer.token;
        this.persistence.write(this.tokenKey, this.token)
          .catch(err => this.log("login", "Persist token failed", err));

        if (viewer.user.autoGenerated) {
          this.oldPassword = user.password;
          this.email = user.email;
        }

        return Promise.resolve(viewer);
      });
  }

  public logoff() {
    this.clearToken();
  }

  public resetPassword(email) {
    return Promise.resolve();
  }

  /**
   * Change password for user. Uses stored user information.
   * @param newPassword The new password.
   */
  public changePassword(newPassword: string): Promise<void> {
    return this.apollo
      .mutate({
        mutation: gql`
          mutation changePassword($token: String!, $password: String!, $newPass: String!) {
            viewer(token: $token) {
              changePassword(oldPassword: $password, newPassword: $newPass) {
                autoGenerated
                updatedAt
              }
            }
          }
        `,
        variables: {
          token: this.token,
          oldPassword: this.oldPassword,
          newPassword,
        },
      })
      .then(() => {
        this.email = undefined;
        this.oldPassword = undefined;
        return this.clearToken();
      })
      .catch((error) => {
        this.email = undefined;
        this.oldPassword = undefined;
        return Promise.reject(error);
      });
  }

  public handleErrors(error) {
    console.log(JSON.stringify(error));
    return Promise.reject(error.message);
  }

  private clearToken(): Promise<string> {
    this.token = "";
    return this.persistence.write(this.tokenKey, "")
      .catch(err => this.log("logoff", "Failed clear token", err));
  }

  private log(method: string, message: string, ...data: Array<any>): void {
    console.log(`LoginService.${method}(): ${message}`, ...data);
  }
}
